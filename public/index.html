<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Pro - API Manager Edition</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --danger: #ef4444; --text: #f1f5f9; --border: #334155; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        /* æ¨™é¡Œ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { font-size: 1.5rem; margin: 0; background: linear-gradient(90deg, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* ä¸»ä½ˆå±€ */
        .grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
        
        /* é¢æ¿æ¨£å¼ */
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 16px; }
        .section-title { font-size: 0.85rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 8px; }

        /* API ç®¡ç†å€å¡Šå°ˆç”¨æ¨£å¼ */
        .api-manager { background: #0b1120; border: 1px solid #475569; padding: 15px; border-radius: 8px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* è¼¸å…¥å…ƒä»¶ */
        label { font-size: 0.8rem; color: #cbd5e1; margin-bottom: 4px; display: block; }
        input, select, textarea { width: 100%; background: #1e293b; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; }
        textarea { height: 100px; resize: vertical; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: filter 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-save { background: #10b981; color: white; flex: 1; }
        .btn-del { background: var(--danger); color: white; }
        .btn:hover { filter: brightness(1.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* ç•«å»Š */
        .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .img-box { aspect-ratio: 16/9; background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        .placeholder { color: #64748b; font-size: 0.9rem; }

        /* Debug Log */
        details { margin-top: 20px; background: #000; border-radius: 8px; }
        summary { padding: 10px; color: #64748b; font-family: monospace; cursor: pointer; }
        pre { color: #22c55e; padding: 15px; margin: 0; overflow: auto; max-height: 200px; font-size: 0.8rem; }

        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1>Gemini 3 Pro Controller</h1>
    <div style="font-size: 0.8rem; color: #64748b;">v3.0 API Manager</div>
</header>

<div class="grid">
    <!-- å·¦å´æ§åˆ¶å€ -->
    <div class="panel">
        
        <!-- 1. API ç®¡ç†æ¨¡çµ„ -->
        <div class="api-manager">
            <div class="section-title">ğŸ“¡ ç·šè·¯è¨­å®š (Endpoints)</div>
            
            <div class="form-group">
                <label>å·²å­˜ç·šè·¯</label>
                <div class="row">
                    <select id="savedApis" onchange="loadApiConfig()">
                        <option value="">-- é¸æ“‡æˆ–æ–°å¢ --</option>
                    </select>
                    <button class="btn btn-del btn-sm" onclick="deleteApi()" title="åˆªé™¤æ­¤ç·šè·¯">ğŸ—‘ï¸</button>
                </div>
            </div>

            <div class="form-group">
                <label>API åç¨± (åˆ¥å)</label>
                <input type="text" id="apiName" placeholder="ä¾‹å¦‚: My Appmedo Proxy" />
            </div>

            <div class="form-group">
                <label>API URL (Endpoint Address)</label>
                <input type="text" id="apiUrl" placeholder="https://..." />
            </div>

            <div class="form-group">
                <label>API Key (Optional)</label>
                <input type="password" id="apiKey" placeholder="AIzaSy..." />
            </div>

            <button class="btn btn-save btn-sm" style="width:100%; margin-top:8px;" onclick="saveApi()">ğŸ’¾ å„²å­˜ / æ›´æ–°ç·šè·¯</button>
        </div>

        <!-- 2. ç”Ÿæˆåƒæ•¸ -->
        <div>
            <div class="section-title">ğŸ¨ ç”Ÿæˆåƒæ•¸</div>
            <label>æç¤ºè© (Prompt)</label>
            <textarea id="prompt" placeholder="Describe the image...">Cyberpunk city, neon lights, 8k, realistic</textarea>
        </div>

        <div class="row">
            <div style="flex:1">
                <label>æ¯”ä¾‹</label>
                <select id="aspectRatio">
                    <option value="16:9">16:9</option>
                    <option value="1:1">1:1</option>
                    <option value="9:16">9:16</option>
                    <option value="4:3">4:3</option>
                    <option value="3:4">3:4</option>
                </select>
            </div>
            <div style="flex:1">
                <label>æ•¸é‡</label>
                <select id="sampleCount">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="4">4</option>
                </select>
            </div>
        </div>

        <button id="btnGenerate" class="btn btn-primary" onclick="generate()">ğŸš€ é–‹å§‹ç”Ÿæˆ (Generate)</button>
        <div id="status" style="text-align: center; color: #94a3b8; font-size: 0.85rem;">Ready</div>
    </div>

    <!-- å³å´å±•ç¤ºå€ -->
    <div class="panel">
        <div class="section-title">ğŸ–¼ï¸ çµæœé è¦½</div>
        <div id="gallery" class="gallery">
            <div class="img-box"><span class="placeholder">ç­‰å¾…ç”Ÿæˆ...</span></div>
        </div>
    </div>
</div>

<details>
    <summary>ğŸ› ï¸ System Log</summary>
    <pre id="apiOutput">// Waiting for request...</pre>
</details>

<script>
    // --- API ç®¡ç†é‚è¼¯ ---
    const STORAGE_KEY = 'gemini_api_configs_v3';
    let apiList = [];

    // åˆå§‹åŒ–
    window.onload = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            apiList = JSON.parse(stored);
            renderApiSelect();
            // é è¨­é¸ä¸­ç¬¬ä¸€å€‹
            if(apiList.length > 0) {
                document.getElementById('savedApis').value = 0;
                loadApiConfig();
            }
        } else {
            // é è¨­åŠ å…¥ä¸€å€‹ç¯„ä¾‹
            apiList = [{
                name: "Default Appmedo",
                url: "https://api-integrations.appmedo.com/app-7r29gu4xs001/api-Xa6JZ58oPMEa/v1beta/models/gemini-3-pro-image-preview:generateContent",
                key: ""
            }];
            saveToStorage();
            renderApiSelect();
        }
    };

    function renderApiSelect() {
        const sel = document.getElementById('savedApis');
        sel.innerHTML = '<option value="">-- æ–°å¢ç·šè·¯ --</option>';
        apiList.forEach((api, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.text = api.name;
            sel.appendChild(opt);
        });
    }

    function loadApiConfig() {
        const idx = document.getElementById('savedApis').value;
        if (idx === "") {
            // æ¸…ç©ºè¡¨å–®ä»¥æ–°å¢
            document.getElementById('apiName').value = "";
            document.getElementById('apiUrl').value = "";
            document.getElementById('apiKey').value = "";
        } else {
            const api = apiList[idx];
            document.getElementById('apiName').value = api.name;
            document.getElementById('apiUrl').value = api.url;
            document.getElementById('apiKey').value = api.key || "";
        }
    }

    function saveApi() {
        const name = document.getElementById('apiName').value;
        const url = document.getElementById('apiUrl').value;
        const key = document.getElementById('apiKey').value;

        if (!name || !url) return alert("åç¨±å’Œ URL ç‚ºå¿…å¡«ï¼");

        const idx = document.getElementById('savedApis').value;
        const newConfig = { name, url, key };

        if (idx === "") {
            // æ–°å¢
            apiList.push(newConfig);
        } else {
            // æ›´æ–°
            apiList[idx] = newConfig;
        }

        saveToStorage();
        renderApiSelect();
        // é¸ä¸­å‰›å‰›å„²å­˜çš„
        document.getElementById('savedApis').value = (idx === "") ? apiList.length - 1 : idx;
        alert("ç·šè·¯å·²å„²å­˜ï¼");
    }

    function deleteApi() {
        const idx = document.getElementById('savedApis').value;
        if (idx === "") return;
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç·šè·¯å—ï¼Ÿ")) return;

        apiList.splice(idx, 1);
        saveToStorage();
        renderApiSelect();
        loadApiConfig();
    }

    function saveToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(apiList));
    }

    // --- ç”Ÿæˆé‚è¼¯ ---
    async function generate() {
        const url = document.getElementById('apiUrl').value;
        const key = document.getElementById('apiKey').value;
        const prompt = document.getElementById('prompt').value;
        const aspectRatio = document.getElementById('aspectRatio').value;
        const sampleCount = parseInt(document.getElementById('sampleCount').value);

        const btn = document.getElementById('btnGenerate');
        const status = document.getElementById('status');
        const gallery = document.getElementById('gallery');
        const apiOut = document.getElementById('apiOutput');

        if (!url) return alert("è«‹å…ˆè¨­å®šæˆ–é¸æ“‡ä¸€å€‹ API URLï¼");
        if (!prompt) return alert("è«‹è¼¸å…¥æç¤ºè©ï¼");

        // UI ç‹€æ…‹
        btn.disabled = true;
        status.innerText = "â³ Requesting...";
        gallery.innerHTML = Array(sampleCount).fill('<div class="img-box"><span class="placeholder">ç”Ÿæˆä¸­...</span></div>').join('');
        apiOut.innerText = `Target: ${url}\nAuth: ${key ? '(Provided)' : '(None)'}\nWaiting...`;

        try {
            // è«‹æ±‚æˆ‘å€‘çš„å¾Œç«¯ Proxy
            const response = await fetch('/api/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-target-url': url,
                    'x-target-key': key
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["IMAGE"],
                        imageConfig: { aspectRatio, imageCount: sampleCount }
                    }
                })
            });

            const rawText = await response.text();
            let data;
            try {
                data = JSON.parse(rawText);
            } catch(e) {
                throw new Error("Proxy Error (Non-JSON): " + rawText.substring(0, 300));
            }

            apiOut.innerText = JSON.stringify(data, null, 2).substring(0, 5000);
            status.innerText = `HTTP ${response.status}`;

            // è§£æ
            const images = [];
            if (data.candidates) {
                data.candidates.forEach(c => {
                    if (c.content?.parts) {
                        c.content.parts.forEach(p => {
                            if (p.inlineData?.data) images.push(p.inlineData.data);
                            else if (p.text) {
                                const m = p.text.match(/data:image\/[^;]+;base64,([A-Za-z0-9+/=]+)/);
                                if (m) images.push(m[1]);
                            }
                        });
                    }
                });
            }

            // æ¸²æŸ“
            if (images.length > 0) {
                gallery.innerHTML = images.map(b64 => `
                    <div class="img-box">
                        <img src="data:image/png;base64,${b64}" onclick="window.open(this.src)" title="Open Full Size" />
                    </div>
                `).join('');
                status.innerText = `âœ… Success: ${images.length} images`;
                status.style.color = "#4ade80";
            } else {
                gallery.innerHTML = `<div class="img-box" style="border-color:#f59e0b"><span class="placeholder" style="color:#f59e0b">ç„¡åœ–ç‰‡å›å‚³</span></div>`;
                status.innerText = "âš ï¸ No Image Data Found";
                status.style.color = "#f59e0b";
            }

        } catch (e) {
            status.innerText = "âŒ Error";
            status.style.color = "#ef4444";
            apiOut.innerText += `\n\nERROR: ${e.message}`;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
