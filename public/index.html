<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Pro Image Generator</title>
    <style>
        :root { --bg: #121212; --card-bg: #1e1e1e; --primary: #3b82f6; --text: #e5e5e5; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1000px; margin: 0 auto; padding: 2rem; background: var(--bg); color: var(--text); }
        h1 { text-align: center; margin-bottom: 2rem; background: linear-gradient(90deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .card { background: var(--card-bg); padding: 1.5rem; border-radius: 1rem; border: 1px solid #333; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        .label { display: block; font-size: 0.875rem; color: #888; margin-bottom: 0.5rem; font-weight: 500; }
        textarea { width: 100%; height: 120px; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 1rem; border-radius: 0.5rem; resize: none; font-size: 1rem; box-sizing: border-box; }
        textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
        button { background: var(--primary); color: white; border: none; padding: 1rem; width: 100%; border-radius: 0.5rem; font-weight: 600; cursor: pointer; margin-top: 1rem; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #4b5563; cursor: not-allowed; opacity: 0.7; }
        #status { margin-top: 1rem; font-size: 0.9rem; text-align: center; min-height: 1.2em; }
        
        /* åœ–ç‰‡å®¹å™¨ */
        .img-container { min-height: 300px; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 0.5rem; overflow: hidden; position: relative; }
        img { max-width: 100%; display: none; }
        .placeholder { color: #555; font-size: 0.9rem; }
        
        /* Debug å€åŸŸ */
        details { margin-top: 2rem; background: #1a1a1a; border-radius: 0.5rem; padding: 0.5rem; }
        summary { cursor: pointer; color: #888; padding: 0.5rem; user-select: none; }
        pre { background: #000; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.75rem; color: #0f0; max-height: 300px; margin: 0.5rem 0 0 0; white-space: pre-wrap; word-break: break-all; }

        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>âœ¨ Gemini 3 Pro åœ–åƒç”Ÿæˆ</h1>
    
    <div class="grid">
        <!-- è¼¸å…¥å€ -->
        <div class="card">
            <label class="label">æç¤ºè© (Prompt)</label>
            <textarea id="prompt" placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„ç•«é¢...&#10;ä¾‹ï¼šA futuristic cyberpunk city, neon lights, rain, 8k resolution">Cyberpunk street at night, neon lights, realistic, 8k</textarea>
            <button id="btn" onclick="generate()">ç”Ÿæˆåœ–ç‰‡ (Generate)</button>
            <div id="status">æº–å‚™å°±ç·’</div>
        </div>

        <!-- çµæœå€ -->
        <div class="card">
            <label class="label">é è¦½çµæœ</label>
            <div class="img-container">
                <span class="placeholder" id="placeholder">ç­‰å¾…ç”Ÿæˆ...</span>
                <img id="outputImage" alt="Generated Result" />
            </div>
        </div>
    </div>

    <!-- Debug å€ -->
    <details>
        <summary>ğŸ› ï¸ é–‹ç™¼è€…è³‡è¨Š (API Response)</summary>
        <pre id="apiOutput">// API å›æ‡‰å°‡é¡¯ç¤ºæ–¼æ­¤...</pre>
    </details>

    <script>
        async function generate() {
            const prompt = document.getElementById('prompt').value;
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            const img = document.getElementById('outputImage');
            const placeholder = document.getElementById('placeholder');
            const apiOut = document.getElementById('apiOutput');

            if (!prompt) return;

            // 1. UI é–å®šèˆ‡é‡ç½®
            btn.disabled = true;
            status.innerText = "â³ æ­£åœ¨è«‹æ±‚ API (é€™å¯èƒ½éœ€è¦ 10-20 ç§’)...";
            status.style.color = "#ccc";
            img.style.display = 'none';
            placeholder.style.display = 'block';
            placeholder.innerText = "æ­£åœ¨ç¹ªåœ–ä¸­...";
            apiOut.innerText = "Waiting for response...";

            try {
                // 2. ç™¼é€è«‹æ±‚
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseModalities: ["IMAGE"],
                            imageConfig: { aspectRatio: "16:9", imageCount: 1 }
                        }
                    })
                });

                // 3. è™•ç†å›æ‡‰æ•¸æ“š
                const rawText = await response.text();
                let data;

                try {
                    data = JSON.parse(rawText);
                } catch (e) {
                    throw new Error(`API å›å‚³äº†é JSON æ ¼å¼ (å¯èƒ½æ˜¯ HTML éŒ¯èª¤é ): \n${rawText.substring(0, 300)}...`);
                }

                // æ›´æ–° Debug é¢æ¿ (æˆªæ–·éé•·çš„ Base64 ä»¥å…ç€è¦½å™¨å¡æ­»)
                const debugJson = JSON.stringify(data, null, 2);
                apiOut.innerText = debugJson.length > 5000 
                    ? debugJson.substring(0, 5000) + "\n... (å…§å®¹éé•·å·²æˆªæ–·)" 
                    : debugJson;

                status.innerText = `ä¼ºæœå™¨å›æ‡‰: ${response.status}`;

                // 4. æ™ºèƒ½è§£æåœ–ç‰‡æ•¸æ“š
                let b64 = null;
                const part = data.candidates?.[0]?.content?.parts?.[0];

                if (part) {
                    if (part.inlineData && part.inlineData.data) {
                        // æƒ…æ³ A: æ¨™æº–æ ¼å¼
                        console.log("æ¨¡å¼: æ¨™æº– inlineData");
                        b64 = part.inlineData.data;
                    } else if (part.text) {
                        // æƒ…æ³ B: Markdown æ ¼å¼
                        console.log("æ¨¡å¼: Markdown text");
                        // ä½¿ç”¨é€šç”¨æ­£å‰‡æå– Base64
                        const match = part.text.match(/data:image\/[^;]+;base64,([A-Za-z0-9+/=]+)/);
                        if (match && match[1]) b64 = match[1];
                    }
                }

                // 5. æ¸²æŸ“åœ–ç‰‡
                if (b64 && b64.length > 100) {
                    img.onload = () => {
                        status.innerText = `âœ… ç”ŸæˆæˆåŠŸï¼(${img.naturalWidth}x${img.naturalHeight})`;
                        status.style.color = "#4ade80"; // Green
                        placeholder.style.display = 'none';
                        img.style.display = 'block';
                    };
                    img.onerror = () => {
                        status.innerText = "âŒ åœ–ç‰‡è§£ç¢¼å¤±æ•— (Base64 æå£)";
                        status.style.color = "#ef4444"; // Red
                    };
                    
                    // è¨­å®šåœ–ç‰‡æº (å¼·åˆ¶ PNG é ­)
                    img.src = `data:image/png;base64,${b64}`;
                } else {
                    status.innerText = "âš ï¸ API å›æ‡‰æ­£å¸¸ä½†æœªæ‰¾åˆ°åœ–ç‰‡æ•¸æ“š";
                    status.style.color = "#f59e0b"; // Orange
                    placeholder.innerText = "ç„¡åœ–ç‰‡æ•¸æ“š";
                    console.error("è§£æå¤±æ•—ï¼Œæ•¸æ“šçµæ§‹:", part);
                }

            } catch (e) {
                status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
                status.style.color = "#ef4444";
                apiOut.innerText = `Error: ${e.message}\n\nStack:\n${e.stack}`;
                console.error(e);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
