        async function generate() {
            const prompt = document.getElementById('prompt').value;
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            const img = document.getElementById('outputImage');
            const apiOut = document.getElementById('apiOutput');

            if (!prompt) return;

            // UI ç‹€æ…‹æ›´æ–°
            btn.disabled = true;
            status.innerText = "â³ è«‹æ±‚å¾Œç«¯ API ä¸­...";
            img.style.display = 'none';
            apiOut.innerText = "Loading...";

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseModalities: ["IMAGE"],
                            imageConfig: { aspectRatio: "16:9", imageCount: 1 }
                        }
                    })
                });

                // è™•ç†é JSON çš„éŒ¯èª¤ (ä¾‹å¦‚ 502/404 HTML é é¢)
                const rawText = await response.text();
                let data;
                try {
                    data = JSON.parse(rawText);
                } catch (e) {
                    throw new Error("API å›å‚³äº†é JSON å…§å®¹ (å¯èƒ½æ˜¯éŒ¯èª¤é é¢):\n" + rawText.substring(0, 200));
                }
                
                // é¡¯ç¤ºåŸå§‹ JSON (Debug ç”¨)
                apiOut.innerText = JSON.stringify(data, null, 2);
                status.innerText = `è«‹æ±‚å®Œæˆ (Status: ${response.status})`;

                // ğŸ¯ æ ¸å¿ƒä¿®æ­£ï¼šå¢å¼·åœ–ç‰‡è§£æé‚è¼¯
                let b64 = null;
                const part = data.candidates?.[0]?.content?.parts?.[0];

                if (part) {
                    if (part.inlineData && part.inlineData.data) {
                        // æƒ…æ³ A: æ¨™æº– Gemini æ ¼å¼
                        b64 = part.inlineData.data;
                    } else if (part.text) {
                        // æƒ…æ³ B: Markdown æ ¼å¼ (ä½ çš„ paste.txt å±¬æ–¼é€™ç¨®)
                        // å°‹æ‰¾ base64 å­—ä¸²
                        const match = part.text.match(/data:image\/png;base64,([^"\)\s]+)/);
                        if (match && match[1]) {
                            b64 = match[1];
                        }
                    }
                }

                if (b64) {
                    img.src = `data:image/png;base64,${b64}`;
                    img.style.display = 'block';
                    status.innerText = "âœ… åœ–ç‰‡ç”ŸæˆæˆåŠŸï¼";
                } else {
                    status.innerText = "âš ï¸ ç”ŸæˆæˆåŠŸï¼Œä½†ç„¡æ³•è§£æåœ–ç‰‡æ•¸æ“š";
                    console.error("ç„¡æ³•è§£æçš„ Part çµæ§‹:", part);
                }

            } catch (e) {
                status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
                apiOut.innerText = "Error: " + e.message;
            } finally {
                btn.disabled = false;
            }
        }
