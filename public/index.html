<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Pro - Auto Model Updater</title>
    <style>
        /* (ä¿ç•™åŸæœ¬çš„ CSS æ¨£å¼ï¼Œé€™è£¡åªå±•ç¤ºæ–°å¢/ä¿®æ”¹çš„éƒ¨åˆ†) */
        :root { --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --danger: #ef4444; --text: #f1f5f9; --border: #334155; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        /* ... å…¶ä»– CSS ä¿æŒä¸è®Š ... */
        .api-manager { background: #0b1120; border: 1px solid #475569; padding: 15px; border-radius: 8px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        label { font-size: 0.8rem; color: #cbd5e1; margin-bottom: 4px; display: block; }
        input, select, textarea { width: 100%; background: #1e293b; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
        button { cursor: pointer; }
        .btn-refresh { background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; white-space: nowrap; }
        
        .badge-new { background: #10b981; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 6px; }

        /* ç•«å»Šæ¨£å¼ (ä¿æŒä¸è®Š) */
        .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .img-box { aspect-ratio: 16/9; background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        details { margin-top: 20px; background: #000; border-radius: 8px; }
        pre { color: #22c55e; padding: 15px; margin: 0; overflow: auto; max-height: 200px; font-size: 0.8rem; }
        /* ... */
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1 style="background: linear-gradient(90deg, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">Gemini 3 Pro Controller</h1>
    <div style="font-size: 0.8rem; color: #64748b;">v4.0 Auto Models</div>
</header>

<div class="grid" style="display: grid; grid-template-columns: 380px 1fr; gap: 24px;">
    <!-- å·¦å´ï¼šæ§åˆ¶é¢æ¿ -->
    <div class="panel" style="background: var(--card); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; gap: 16px;">
        
        <!-- API è¨­å®š -->
        <div class="api-manager">
            <div style="font-size: 0.85rem; font-weight: 700; color: #94a3b8; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 8px;">ğŸ“¡ ç·šè·¯èˆ‡æ¨¡å‹</div>
            
            <!-- ç·šè·¯é¸æ“‡ -->
            <div style="margin-bottom: 12px;">
                <label>é¸æ“‡ç·šè·¯ (Endpoint)</label>
                <div class="row">
                    <select id="savedApis" onchange="loadApiConfig()">
                        <option value="">-- Loading --</option>
                    </select>
                    <button class="btn-refresh" style="background:#ef4444" onclick="deleteApi()">ğŸ—‘ï¸</button>
                </div>
            </div>

            <div style="margin-bottom: 10px;"><label>åç¨±</label><input type="text" id="apiName" /></div>
            <div style="margin-bottom: 10px;"><label>Base URL</label><input type="text" id="apiUrl" /></div>
            <div style="margin-bottom: 10px;"><label>API Key</label><input type="password" id="apiKey" /></div>
            
            <!-- NEW: æ¨¡å‹è‡ªå‹•é¸æ“‡å™¨ -->
            <div style="background: #1e1b4b; padding: 10px; border-radius: 6px; border: 1px solid #4c1d95; margin-bottom: 10px;">
                <div class="row" style="align-items: center; justify-content: space-between; margin-bottom: 6px;">
                    <label style="color:#a78bfa; margin:0;">ğŸ¤– ä½¿ç”¨æ¨¡å‹</label>
                    <button class="btn-refresh" onclick="fetchModels()">ğŸ”„ æ›´æ–°åˆ—è¡¨</button>
                </div>
                <select id="modelSelector" onchange="updateUrlWithModel()">
                    <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview (Default)</option>
                    <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                </select>
                <div style="font-size:0.7rem; color:#6b7280; margin-top:4px;">* é¸å–å¾Œæœƒè‡ªå‹•æ›´æ–°ä¸Šæ–¹ URL</div>
            </div>

            <button class="btn-refresh" style="width:100%; background:#10b981;" onclick="saveApi()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>

        <!-- åƒæ•¸è¨­å®š -->
        <div>
            <label>æç¤ºè©</label>
            <textarea id="prompt">Cyberpunk city, neon lights, 8k, realistic</textarea>
        </div>
        
        <div class="row">
            <div style="flex:1"><label>æ¯”ä¾‹</label><select id="aspectRatio"><option value="16:9">16:9</option><option value="1:1">1:1</option></select></div>
            <div style="flex:1"><label>æ•¸é‡</label><select id="sampleCount"><option value="1">1</option><option value="2">2</option><option value="4">4</option></select></div>
        </div>

        <button id="btnGenerate" style="background:var(--primary); color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;" onclick="generate()">ğŸš€ é–‹å§‹ç”Ÿæˆ</button>
        <div id="status" style="text-align:center; margin-top:10px; color:#94a3b8; font-size:0.8rem;">Ready</div>
    </div>

    <!-- å³å´ï¼šçµæœ -->
    <div class="panel" style="background: var(--card); border-radius: 10px; padding: 20px;">
        <div style="font-size: 0.85rem; font-weight: 700; color: #94a3b8; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 8px;">ğŸ–¼ï¸ çµæœé è¦½</div>
        <div id="gallery" class="gallery">
            <div class="img-box"><span style="color:#64748b">åœ–ç‰‡å€åŸŸ</span></div>
        </div>
    </div>
</div>

<details>
    <summary>ğŸ› ï¸ Log</summary>
    <pre id="apiOutput">// ...</pre>
</details>

<script>
    const STORAGE_KEY = 'gemini_config_v4';
    let apiList = [];

    // åˆå§‹åŒ–
    window.onload = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            apiList = JSON.parse(stored);
        } else {
            // é è¨­é…ç½®
            apiList = [{
                name: "Official Google API",
                url: "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent",
                key: ""
            }];
            saveToStorage();
        }
        renderApiSelect();
        if(apiList.length > 0) {
            document.getElementById('savedApis').value = 0;
            loadApiConfig();
        }
    };

    // --- æ¨¡å‹ç²å–é‚è¼¯ ---
    async function fetchModels() {
        const apiKey = document.getElementById('apiKey').value;
        const selector = document.getElementById('modelSelector');
        const status = document.getElementById('status');

        if (!apiKey) return alert("è«‹å…ˆè¼¸å…¥ API Key æ‰èƒ½ç²å–æ¨¡å‹åˆ—è¡¨ï¼");

        status.innerText = "æ­£åœ¨å¾ Google ç²å–æ¨¡å‹åˆ—è¡¨...";
        selector.innerHTML = "<option>Loading...</option>";
        selector.disabled = true;

        try {
            const response = await fetch('/api/models', {
                headers: { 'x-api-key': apiKey }
            });
            const data = await response.json();

            if (data.models) {
                selector.innerHTML = "";
                // ç¯©é¸ä¸¦æ’åºæ¨¡å‹
                const models = data.models.sort((a,b) => b.name.localeCompare(a.name));
                
                models.forEach(m => {
                    // åªé¡¯ç¤ºæ”¯æ´ generateContent çš„æ¨¡å‹
                    if (m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")) {
                        const modelId = m.name.replace("models/", "");
                        const opt = document.createElement('option');
                        opt.value = modelId;
                        
                        // æ¨™è¨˜ä¸€ä¸‹æ¯”è¼ƒå²å®³çš„æ¨¡å‹
                        let label = modelId;
                        if (modelId.includes("gemini-3")) label += " ğŸ”¥";
                        else if (modelId.includes("image")) label += " ğŸ–¼ï¸";
                        
                        opt.text = label;
                        selector.appendChild(opt);
                    }
                });
                status.innerText = `âœ… å·²æ›´æ–° ${models.length} å€‹æ¨¡å‹`;
            } else {
                throw new Error("ç„¡æ³•è§£ææ¨¡å‹åˆ—è¡¨");
            }
        } catch (e) {
            alert("ç²å–å¤±æ•—: " + e.message);
            selector.innerHTML = "<option value='gemini-3-pro-image-preview'>gemini-3-pro-image-preview (Fallback)</option>";
        } finally {
            selector.disabled = false;
        }
    }

    // ç•¶é¸æ“‡æ–°æ¨¡å‹æ™‚ï¼Œè‡ªå‹•æ›´æ–° URL æ¬„ä½
    function updateUrlWithModel() {
        const model = document.getElementById('modelSelector').value;
        const currentUrl = document.getElementById('apiUrl').value;
        
        // ç°¡å–®çš„æ­£å‰‡æ›¿æ›ï¼Œå°‡ URL ä¸­çš„ models/xxx:generateContent æ›¿æ›æ‰
        if (currentUrl.includes("/models/")) {
            const newUrl = currentUrl.replace(/\/models\/[^:]+/, `/models/${model}`);
            document.getElementById('apiUrl').value = newUrl;
        } else {
            // å¦‚æœåŸæœ¬ URL æ ¼å¼ä¸å°ï¼Œå°±ç›´æ¥çµ¦ä¸€å€‹æ¨™æº–çš„ Google URL
            document.getElementById('apiUrl').value = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
        }
    }

    // --- (ä»¥ä¸‹æ˜¯åŸæœ¬çš„ CRUD å’Œ Generate é‚è¼¯ï¼Œä¿æŒç²¾ç°¡) ---
    function renderApiSelect() {
        const s = document.getElementById('savedApis'); s.innerHTML = '<option value="">-- New --</option>';
        apiList.forEach((a,i) => {const o=document.createElement('option');o.value=i;o.text=a.name;s.appendChild(o)});
    }
    function loadApiConfig() {
        const idx = document.getElementById('savedApis').value;
        if(idx===""){ document.getElementById('apiName').value=""; document.getElementById('apiUrl').value=""; document.getElementById('apiKey').value=""; }
        else { const a=apiList[idx]; document.getElementById('apiName').value=a.name; document.getElementById('apiUrl').value=a.url; document.getElementById('apiKey').value=a.key||""; }
    }
    function saveApi() {
        const n=document.getElementById('apiName').value, u=document.getElementById('apiUrl').value, k=document.getElementById('apiKey').value, idx=document.getElementById('savedApis').value;
        if(!n) return alert("è«‹è¼¸å…¥åç¨±");
        const conf={name:n,url:u,key:k};
        if(idx==="") apiList.push(conf); else apiList[idx]=conf;
        saveToStorage(); renderApiSelect(); document.getElementById('savedApis').value = (idx==="")?apiList.length-1:idx;
    }
    function deleteApi() { const idx=document.getElementById('savedApis').value; if(idx!==""){apiList.splice(idx,1);saveToStorage();renderApiSelect();loadApiConfig();} }
    function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(apiList)); }

    async function generate() {
        const url = document.getElementById('apiUrl').value;
        const key = document.getElementById('apiKey').value;
        const prompt = document.getElementById('prompt').value;
        const aspectRatio = document.getElementById('aspectRatio').value;
        const sampleCount = parseInt(document.getElementById('sampleCount').value);
        const btn = document.getElementById('btnGenerate');
        const status = document.getElementById('status');
        const gallery = document.getElementById('gallery');
        const apiOut = document.getElementById('apiOutput');

        if (!url || !prompt) return alert("Missing Info");
        
        btn.disabled = true; status.innerText = "Generating...";
        gallery.innerHTML = Array(sampleCount).fill('<div class="img-box"><span>...</span></div>').join('');

        try {
            const res = await fetch('/api/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-target-url': url, 'x-target-key': key },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseModalities: ["IMAGE"], imageConfig: { aspectRatio, imageCount: sampleCount } }
                })
            });
            const raw = await res.text();
            let data; try { data = JSON.parse(raw); } catch(e) { throw new Error(raw.substring(0,200)); }
            apiOut.innerText = JSON.stringify(data, null, 2).substring(0,3000);
            status.innerText = "HTTP " + res.status;

            const images = [];
            if(data.candidates) {
                data.candidates.forEach(c => {
                    if(c.content?.parts) c.content.parts.forEach(p => {
                        if(p.inlineData?.data) images.push(p.inlineData.data);
                        else if(p.text) {
                            const re = /data:image\/[^;]+;base64,([A-Za-z0-9+/=]+)/g;
                            let m; while(m=re.exec(p.text)) if(m[1]) images.push(m[1]);
                        }
                    });
                });
            }
            const unique = [...new Set(images)];
            if(unique.length>0) {
                gallery.innerHTML = unique.map(b64 => `<div class="img-box"><img src="data:image/png;base64,${b64}" onclick="window.open(this.src)"/></div>`).join('');
                status.innerText = "âœ… Done";
            } else {
                gallery.innerHTML = "No Image";
            }
        } catch(e) {
            status.innerText = "Error"; apiOut.innerText = e.message;
        } finally { btn.disabled = false; }
    }
</script>

</body>
</html>
