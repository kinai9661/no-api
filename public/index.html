<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Pro - Info Station</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --danger: #ef4444; --text: #f1f5f9; --border: #334155; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        /* Layout */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { font-size: 1.5rem; margin: 0; background: linear-gradient(90deg, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .section-title { font-size: 0.85rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 8px; }
        
        /* Inputs */
        .api-manager { background: #0b1120; border: 1px solid #475569; padding: 15px; border-radius: 8px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        label { font-size: 0.8rem; color: #cbd5e1; margin-bottom: 4px; display: block; }
        input, select, textarea { width: 100%; background: #1e293b; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        textarea { height: 120px; resize: vertical; }
        
        /* Buttons */
        .btn { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-save { background: #10b981; color: white; flex: 1; }
        .btn-del { background: var(--danger); color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Preview */
        .preview-area { min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px; }
        img { max-width: 100%; max-height: 500px; object-fit: contain; display: none; cursor: pointer; }
        .placeholder { color: #64748b; font-size: 0.9rem; }

        /* Info Card */
        .info-card { background: #0b1120; padding: 12px; border-radius: 6px; border: 1px solid #334155; font-family: monospace; font-size: 0.8rem; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #1e293b; padding-bottom: 8px; }
        .info-label { color: #94a3b8; font-weight: bold; }
        .info-value { color: #60a5fa; word-break: break-all; text-align: right; max-width: 65%; }

        /* Debug */
        details { margin-top: 20px; background: #000; border-radius: 8px; }
        summary { padding: 10px; color: #64748b; font-family: monospace; cursor: pointer; }
        pre { color: #22c55e; padding: 15px; margin: 0; overflow: auto; max-height: 200px; font-size: 0.8rem; }

        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1>Gemini 3 Pro Station</h1>
    <div style="font-size: 0.8rem; color: #64748b;">v3.4 Info Edition</div>
</header>

<div class="grid">
    <!-- Setting Panel -->
    <div class="panel">
        <div class="api-manager">
            <div class="section-title">üì° API Config</div>
            <div class="form-group">
                <div class="row">
                    <select id="savedApis" onchange="loadApiConfig()"><option value="">-- New --</option></select>
                    <button class="btn btn-del" onclick="deleteApi()">üóëÔ∏è</button>
                </div>
            </div>
            <div style="margin-bottom:8px"><label>Name</label><input type="text" id="apiName" placeholder="My Proxy" /></div>
            <div style="margin-bottom:8px"><label>Endpoint URL</label><input type="text" id="apiUrl" placeholder="https://..." /></div>
            <div style="margin-bottom:8px"><label>API Key (Optional)</label><input type="password" id="apiKey" /></div>
            <button class="btn btn-save" style="width:100%" onclick="saveApi()">üíæ Save Config</button>
        </div>

        <div>
            <div class="section-title">üé® Parameters</div>
            <label>Prompt</label>
            <textarea id="prompt">Cyberpunk city, neon lights, 8k</textarea>
        </div>
        
        <div class="row">
            <div style="flex:1">
                <label>Aspect Ratio</label>
                <select id="aspectRatio">
                    <option value="16:9">16:9</option>
                    <option value="1:1">1:1</option>
                    <option value="9:16">9:16</option>
                    <option value="4:3">4:3</option>
                </select>
            </div>
        </div>

        <button id="btnGenerate" class="btn btn-primary" onclick="generate()">üöÄ Generate Image</button>
        <div id="status" style="text-align:center; margin-top:10px; color:#94a3b8; font-size:0.85rem;">Ready</div>
    </div>

    <!-- Result Panel -->
    <div class="panel">
        <div class="section-title">üñºÔ∏è Result</div>
        
        <div class="preview-area">
            <span class="placeholder" id="placeholder">Waiting for generation...</span>
            <img id="resultImage" onclick="window.open(this.src)" title="Open in new tab" />
        </div>

        <!-- Info Panel -->
        <div class="info-card">
            <div class="section-title" style="border:none; margin:0 0 8px 0; color:#3b82f6;">üìä API Transaction Details</div>
            
            <!-- ÈÄôË£°È°ØÁ§∫„ÄåÂâçÁ´ØÁôºÈÄÅÁöÑÁõÆÊ®ô„Äç -->
            <div class="info-row">
                <span class="info-label">Configured URL:</span>
                <span class="info-value" id="dispConfigUrl">N/A</span>
            </div>

            <!-- ÈÄôË£°È°ØÁ§∫„ÄåÂæåÁ´ØÂØ¶ÈöõÊâìÂá∫ÂéªÁöÑÂú∞ÂùÄ„Äç (Êñ∞Â¢ûÂäüËÉΩ) -->
            <div class="info-row">
                <span class="info-label">Actual Outgoing URL:</span>
                <span class="info-value" id="dispActualUrl" style="color:#a78bfa;">Waiting...</span>
            </div>

            <div class="info-row">
                <span class="info-label">HTTP Status:</span>
                <span class="info-value" id="dispStatus">-</span>
            </div>
            <div class="info-row" style="border:none;">
                <span class="info-label">Payload Size:</span>
                <span class="info-value" id="dispSize">0 KB</span>
            </div>
        </div>
    </div>
</div>

<details>
    <summary>üõ†Ô∏è Raw API Output</summary>
    <pre id="apiOutput">// Waiting...</pre>
</details>

<script>
    // --- API Manager Logic ---
    const STORAGE_KEY = 'gemini_api_configs_v3';
    let apiList = [];
    window.onload = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) { apiList = JSON.parse(stored); } 
        else { apiList = [{name: "Official Google (Example)", url: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent", key: ""}]; saveToStorage(); }
        renderApiSelect();
        if(apiList.length > 0) { document.getElementById('savedApis').value = 0; loadApiConfig(); }
    };
    function renderApiSelect() { const sel=document.getElementById('savedApis'); sel.innerHTML='<option value="">-- New --</option>'; apiList.forEach((a,i)=>{const o=document.createElement('option');o.value=i;o.text=a.name;sel.appendChild(o)}); }
    function loadApiConfig() { const idx=document.getElementById('savedApis').value; if(idx===""){document.getElementById('apiName').value="";document.getElementById('apiUrl').value="";document.getElementById('apiKey').value="";}else{const a=apiList[idx];document.getElementById('apiName').value=a.name;document.getElementById('apiUrl').value=a.url;document.getElementById('apiKey').value=a.key||"";} }
    function saveApi() { const n=document.getElementById('apiName').value,u=document.getElementById('apiUrl').value,k=document.getElementById('apiKey').value,idx=document.getElementById('savedApis').value; if(!n||!u)return alert("Required fields missing"); const c={name:n,url:u,key:k}; if(idx===""){apiList.push(c)}else{apiList[idx]=c}; saveToStorage(); renderApiSelect(); loadApiConfig(); alert("Saved"); }
    function deleteApi() { const idx=document.getElementById('savedApis').value; if(idx==="")return; apiList.splice(idx,1); saveToStorage(); renderApiSelect(); loadApiConfig(); }
    function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(apiList)); }

    // --- Generate Logic ---
    async function generate() {
        const url = document.getElementById('apiUrl').value;
        const key = document.getElementById('apiKey').value;
        const prompt = document.getElementById('prompt').value;
        const aspectRatio = document.getElementById('aspectRatio').value;

        // Elements
        const btn = document.getElementById('btnGenerate');
        const status = document.getElementById('status');
        const img = document.getElementById('resultImage');
        const ph = document.getElementById('placeholder');
        const apiOut = document.getElementById('apiOutput');
        
        // Info Elements
        const dConfigUrl = document.getElementById('dispConfigUrl');
        const dActualUrl = document.getElementById('dispActualUrl');
        const dStatus = document.getElementById('dispStatus');
        const dSize = document.getElementById('dispSize');

        if (!url || !prompt) return alert("URL and Prompt are required");

        // UI Reset
        btn.disabled = true;
        status.innerText = "‚è≥ Requesting...";
        img.style.display = 'none';
        ph.style.display = 'block';
        ph.innerText = "Generating...";
        
        dConfigUrl.innerText = url;
        dActualUrl.innerText = "Processing...";
        dStatus.innerText = "Pending...";
        dSize.innerText = "...";

        try {
            const response = await fetch('/api/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-target-url': url,
                    'x-target-key': key
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["IMAGE"],
                        imageConfig: { aspectRatio, imageCount: 1 }
                    }
                })
            });

            // ËÆÄÂèñÂæåÁ´ØÂõûÂÇ≥ÁöÑËá™ÂÆöÁæ© Header
            const actualDestination = response.headers.get('x-final-destination');
            if (actualDestination) {
                dActualUrl.innerText = actualDestination;
            } else {
                dActualUrl.innerText = "Unknown (Header missing)";
            }

            const rawText = await response.text();
            dSize.innerText = (rawText.length / 1024).toFixed(2) + " KB";
            dStatus.innerText = `HTTP ${response.status}`;

            let data;
            try { data = JSON.parse(rawText); } catch(e) { throw new Error("Non-JSON Response"); }

            apiOut.innerText = JSON.stringify(data, null, 2).substring(0, 5000);

            let b64 = null;
            if (data.candidates?.[0]?.content?.parts) {
                const parts = data.candidates[0].content.parts;
                for (const part of parts) {
                    if (part.inlineData?.data) {
                        b64 = part.inlineData.data;
                        break;
                    } else if (part.text) {
                        if (part.text.includes("image upload err")) {
                            throw new Error("Proxy Error: Image upload failed at upstream");
                        }
                        const match = part.text.match(/data:image\/[^;]+;base64,([A-Za-z0-9+/=]+)/);
                        if (match && match[1]) {
                            b64 = match[1];
                            break;
                        }
                    }
                }
            }

            if (b64) {
                img.src = `data:image/png;base64,${b64}`;
                img.style.display = 'block';
                ph.style.display = 'none';
                status.innerText = "‚úÖ Success";
                status.style.color = "#4ade80";
            } else {
                status.innerText = "‚ö†Ô∏è No Image Found";
                status.style.color = "#f59e0b";
                ph.innerText = "No Image Data";
            }

        } catch (e) {
            status.innerText = "‚ùå Error";
            status.style.color = "#ef4444";
            ph.innerText = e.message;
            apiOut.innerText += `\n\nERROR: ${e.message}`;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
