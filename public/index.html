<script>
    async function generate() {
        const prompt = document.getElementById('prompt').value;
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const img = document.getElementById('outputImage');
        const apiOut = document.getElementById('apiOutput');

        if (!prompt) return;

        // 1. UI ç‹€æ…‹æ›´æ–°ï¼šé–å®šæŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
        btn.disabled = true;
        status.innerText = "â³ è«‹æ±‚å¾Œç«¯ API ä¸­...";
        img.style.display = 'none';
        apiOut.innerText = "Loading...";

        try {
            // 2. ç™¼é€è«‹æ±‚çµ¦ä½ çš„ Zeabur å¾Œç«¯
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["IMAGE"],
                        imageConfig: { aspectRatio: "16:9", imageCount: 1 }
                    }
                })
            });

            // 3. ç²å–åŸå§‹æ–‡æœ¬ (ç‚ºäº†è™•ç†å¯èƒ½çš„ HTML éŒ¯èª¤é é¢)
            const rawText = await response.text();
            let data;
            
            try {
                data = JSON.parse(rawText);
            } catch (e) {
                // å¦‚æœè§£æ JSON å¤±æ•—ï¼Œé€šå¸¸ä»£è¡¨ API å ±éŒ¯å›å‚³äº† HTML
                throw new Error("API å›å‚³äº†é JSON å…§å®¹ (å¯èƒ½æ˜¯ 502/404 éŒ¯èª¤):\n" + rawText.substring(0, 200) + "...");
            }
            
            // é¡¯ç¤ºåŸå§‹ JSON (Debug ç”¨)
            apiOut.innerText = JSON.stringify(data, null, 2);
            status.innerText = `è«‹æ±‚å®Œæˆ (Status: ${response.status})`;

            // 4. ğŸ¯ æ ¸å¿ƒä¿®æ­£ï¼šæ™ºèƒ½åœ–ç‰‡è§£æé‚è¼¯
            let b64 = null;
            const part = data.candidates?.[0]?.content?.parts?.[0];

            if (part) {
                if (part.inlineData && part.inlineData.data) {
                    // æƒ…æ³ A: æ¨™æº– Gemini æ ¼å¼ (ç›´æ¥åœ¨ inlineData è£¡)
                    b64 = part.inlineData.data;
                } else if (part.text) {
                    // æƒ…æ³ B: Markdown æ ¼å¼ (ä½ çš„ paste.txt å±¬æ–¼é€™ç¨®)
                    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼å¾æ–‡å­—ä¸­æå– base64 åœ–ç‰‡æ•¸æ“š
                    const match = part.text.match(/data:image\/png;base64,([^"\)\s]+)/);
                    if (match && match[1]) {
                        b64 = match[1];
                    }
                }
            }

            // 5. é¡¯ç¤ºåœ–ç‰‡æˆ–å ±éŒ¯
            if (b64) {
                // æ³¨æ„ï¼šä¸éœ€è¦å†åŠ ä¸Š 'data:image/png;base64,' å› ç‚ºæ­£å‰‡å¯èƒ½å·²ç¶“åŒ…å«äº†ï¼Œæˆ–è€…æ ¼å¼éœ€è¦èª¿æ•´
                // ä¿®æ­£ï¼šä¸Šé¢çš„æ­£å‰‡åªæŠ“å–äº†é€—è™Ÿå¾Œé¢çš„æ•¸æ“šï¼Œæ‰€ä»¥é€™è£¡éœ€è¦è£œä¸Šå‰ç¶´
                img.src = `data:image/png;base64,${b64}`;
                img.style.display = 'block';
                status.innerText = "âœ… åœ–ç‰‡ç”ŸæˆæˆåŠŸï¼";
            } else {
                status.innerText = "âš ï¸ ç”ŸæˆæˆåŠŸï¼Œä½†ç„¡æ³•è§£æåœ–ç‰‡æ•¸æ“š";
                console.error("ç„¡æ³•è§£æçš„ Part çµæ§‹:", part);
            }

        } catch (e) {
            status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
            apiOut.innerText = "Error: " + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }
</script>
