<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Pro - Stable Station</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --danger: #ef4444; --text: #f1f5f9; --border: #334155; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        /* æ¨™é¡Œ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { font-size: 1.5rem; margin: 0; background: linear-gradient(90deg, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* ä½ˆå±€ */
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 16px; }
        .section-title { font-size: 0.85rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 8px; }
        
        /* è¼¸å…¥å€ */
        .api-manager { background: #0b1120; border: 1px solid #475569; padding: 15px; border-radius: 8px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        label { font-size: 0.8rem; color: #cbd5e1; margin-bottom: 4px; display: block; }
        input, select, textarea { width: 100%; background: #1e293b; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; }
        textarea { height: 120px; resize: vertical; }
        
        /* æŒ‰éˆ• */
        .btn { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: filter 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-save { background: #10b981; color: white; flex: 1; }
        .btn-del { background: var(--danger); color: white; }
        .btn:hover { filter: brightness(1.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* çµæœå±•ç¤º */
        .preview-area { min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px; }
        img { max-width: 100%; max-height: 500px; object-fit: contain; display: none; border-radius: 4px; cursor: pointer; }
        .placeholder { color: #64748b; font-size: 0.9rem; }

        /* è©³ç´°è³‡è¨Šå¡ */
        .info-card { background: #0b1120; padding: 12px; border-radius: 6px; border: 1px solid #334155; margin-top: 16px; font-family: monospace; font-size: 0.8rem; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #1e293b; padding-bottom: 8px; }
        .info-label { color: #94a3b8; font-weight: bold; }
        .info-value { color: #60a5fa; word-break: break-all; text-align: right; max-width: 70%; }

        /* Debug Log */
        details { margin-top: 20px; background: #000; border-radius: 8px; }
        summary { padding: 10px; color: #64748b; font-family: monospace; cursor: pointer; }
        pre { color: #22c55e; padding: 15px; margin: 0; overflow: auto; max-height: 200px; font-size: 0.8rem; }

        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1>Gemini 3 Pro Station</h1>
    <div style="font-size: 0.8rem; color: #64748b;">v3.3 Stable</div>
</header>

<div class="grid">
    <!-- å·¦å´ï¼šè¨­å®šå€ -->
    <div class="panel">
        
        <!-- API ç®¡ç† -->
        <div class="api-manager">
            <div class="section-title">ğŸ“¡ ç·šè·¯è¨­å®š (Endpoints)</div>
            <div class="form-group">
                <label>é¸æ“‡ç·šè·¯</label>
                <div class="row">
                    <select id="savedApis" onchange="loadApiConfig()">
                        <option value="">-- æ–°å¢ --</option>
                    </select>
                    <button class="btn btn-del" onclick="deleteApi()">ğŸ—‘ï¸</button>
                </div>
            </div>
            <div style="margin-bottom:8px"><label>åç¨±</label><input type="text" id="apiName" placeholder="My Proxy" /></div>
            <div style="margin-bottom:8px"><label>URL</label><input type="text" id="apiUrl" placeholder="https://..." /></div>
            <div style="margin-bottom:8px"><label>Key</label><input type="password" id="apiKey" placeholder="(é¸å¡«)" /></div>
            <button class="btn btn-save" style="width:100%" onclick="saveApi()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>

        <!-- åƒæ•¸å€ -->
        <div>
            <div class="section-title">ğŸ¨ åƒæ•¸</div>
            <label>æç¤ºè© (Prompt)</label>
            <textarea id="prompt">Cyberpunk city, neon lights, 8k</textarea>
        </div>
        
        <div class="row">
            <div style="flex:1">
                <label>æ¯”ä¾‹</label>
                <select id="aspectRatio">
                    <option value="16:9">16:9</option>
                    <option value="1:1">1:1</option>
                    <option value="9:16">9:16</option>
                    <option value="4:3">4:3</option>
                </select>
            </div>
            <!-- éš±è—æ•¸é‡é¸æ“‡ï¼Œå›ºå®šç‚º 1 -->
        </div>

        <button id="btnGenerate" class="btn btn-primary" onclick="generate()">ğŸš€ ç”Ÿæˆåœ–ç‰‡</button>
        <div id="status" style="text-align:center; margin-top:10px; color:#94a3b8; font-size:0.85rem;">Ready</div>
    </div>

    <!-- å³å´ï¼šçµæœå€ -->
    <div class="panel">
        <div class="section-title">ğŸ–¼ï¸ çµæœé è¦½</div>
        
        <div class="preview-area">
            <span class="placeholder" id="placeholder">ç­‰å¾…ç”Ÿæˆ...</span>
            <img id="resultImage" onclick="window.open(this.src)" title="é»æ“Šåœ¨æ–°åˆ†é é–‹å•Ÿ" />
        </div>

        <!-- API è©³ç´°è³‡è¨Š -->
        <div class="info-card">
            <div class="section-title" style="border:none; margin:0 0 8px 0; color:#3b82f6;">ğŸ“Š API Transaction Details</div>
            
            <div class="info-row">
                <span class="info-label">Request Target:</span>
                <span class="info-value" id="dispTarget">N/A</span>
            </div>
            <div class="info-row">
                <span class="info-label">Auth Key Status:</span>
                <span class="info-value" id="dispKey">None</span>
            </div>
            <div class="info-row">
                <span class="info-label">Response Status:</span>
                <span class="info-value" id="dispStatus">-</span>
            </div>
            <div class="info-row" style="border:none;">
                <span class="info-label">Payload Size:</span>
                <span class="info-value" id="dispSize">0 KB</span>
            </div>
        </div>
    </div>
</div>

<details>
    <summary>ğŸ› ï¸ Raw API Output</summary>
    <pre id="apiOutput">// Waiting...</pre>
</details>

<script>
    // --- API ç®¡ç† (ä¿æŒä¸è®Š) ---
    const STORAGE_KEY = 'gemini_api_configs_v3';
    let apiList = [];
    window.onload = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) { apiList = JSON.parse(stored); } 
        else { apiList = [{name: "Default Appmedo", url: "https://api-integrations.appmedo.com/app-7r29gu4xs001/api-Xa6JZ58oPMEa/v1beta/models/gemini-3-pro-image-preview:generateContent", key: ""}]; saveToStorage(); }
        renderApiSelect();
        if(apiList.length > 0) { document.getElementById('savedApis').value = 0; loadApiConfig(); }
    };
    function renderApiSelect() { const sel=document.getElementById('savedApis'); sel.innerHTML='<option value="">-- æ–°å¢ --</option>'; apiList.forEach((a,i)=>{const o=document.createElement('option');o.value=i;o.text=a.name;sel.appendChild(o)}); }
    function loadApiConfig() { const idx=document.getElementById('savedApis').value; if(idx===""){document.getElementById('apiName').value="";document.getElementById('apiUrl').value="";document.getElementById('apiKey').value="";}else{const a=apiList[idx];document.getElementById('apiName').value=a.name;document.getElementById('apiUrl').value=a.url;document.getElementById('apiKey').value=a.key||"";} }
    function saveApi() { const n=document.getElementById('apiName').value,u=document.getElementById('apiUrl').value,k=document.getElementById('apiKey').value,idx=document.getElementById('savedApis').value; if(!n||!u)return alert("å¿…å¡«"); const c={name:n,url:u,key:k}; if(idx===""){apiList.push(c)}else{apiList[idx]=c}; saveToStorage(); renderApiSelect(); loadApiConfig(); alert("Saved"); }
    function deleteApi() { const idx=document.getElementById('savedApis').value; if(idx==="")return; apiList.splice(idx,1); saveToStorage(); renderApiSelect(); loadApiConfig(); }
    function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(apiList)); }

    // --- ç”Ÿæˆé‚è¼¯ (å–®åœ–ç²¾ç°¡ç‰ˆ) ---
    async function generate() {
        const url = document.getElementById('apiUrl').value;
        const key = document.getElementById('apiKey').value;
        const prompt = document.getElementById('prompt').value;
        const aspectRatio = document.getElementById('aspectRatio').value;

        // UI å…ƒç´ 
        const btn = document.getElementById('btnGenerate');
        const status = document.getElementById('status');
        const img = document.getElementById('resultImage');
        const placeholder = document.getElementById('placeholder');
        const apiOut = document.getElementById('apiOutput');
        
        // Info å…ƒç´ 
        const dTarget = document.getElementById('dispTarget');
        const dKey = document.getElementById('dispKey');
        const dStatus = document.getElementById('dispStatus');
        const dSize = document.getElementById('dispSize');

        if (!url || !prompt) return alert("è«‹å¡«å¯« URL å’Œ Prompt");

        // ç‹€æ…‹é‡ç½®
        btn.disabled = true;
        status.innerText = "â³ Requesting...";
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.innerText = "ç”Ÿæˆä¸­...";
        
        // å¡«å……è³‡è¨Šé¢æ¿
        dTarget.innerText = url;
        dKey.innerText = key ? "Provided (Hidden)" : "None";
        dStatus.innerText = "Pending...";
        dSize.innerText = "...";

        try {
            const response = await fetch('/api/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-target-url': url,
                    'x-target-key': key
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["IMAGE"],
                        imageConfig: { 
                            aspectRatio: aspectRatio, 
                            imageCount: 1 // å¼·åˆ¶å–®å¼µ
                        }
                    }
                })
            });

            const rawText = await response.text();
            dSize.innerText = (rawText.length / 1024).toFixed(2) + " KB";
            dStatus.innerText = `HTTP ${response.status}`;

            let data;
            try { data = JSON.parse(rawText); } catch(e) { throw new Error("API Non-JSON Error"); }

            apiOut.innerText = JSON.stringify(data, null, 2).substring(0, 5000);

            // åœ–ç‰‡æå–
            let b64 = null;
            if (data.candidates?.[0]?.content?.parts) {
                const parts = data.candidates[0].content.parts;
                for (const part of parts) {
                    if (part.inlineData?.data) {
                        b64 = part.inlineData.data;
                        break;
                    } else if (part.text) {
                        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
                        if (part.text.includes("image upload err")) {
                            throw new Error("Proxy Error: åœ–åºŠæå£ (image upload err)");
                        }
                        const match = part.text.match(/data:image\/[^;]+;base64,([A-Za-z0-9+/=]+)/);
                        if (match && match[1]) {
                            b64 = match[1];
                            break;
                        }
                    }
                }
            }

            if (b64) {
                img.src = `data:image/png;base64,${b64}`;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                status.innerText = "âœ… ç”ŸæˆæˆåŠŸ";
                status.style.color = "#4ade80";
            } else {
                status.innerText = "âš ï¸ æœªæ‰¾åˆ°åœ–ç‰‡";
                status.style.color = "#f59e0b";
                placeholder.innerText = "ç„¡åœ–ç‰‡æ•¸æ“š";
            }

        } catch (e) {
            status.innerText = "âŒ éŒ¯èª¤";
            status.style.color = "#ef4444";
            placeholder.innerText = "Error: " + e.message;
            apiOut.innerText += `\n\n[ERROR]: ${e.message}`;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
