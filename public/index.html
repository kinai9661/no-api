<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Pro - Ultimate Station</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --danger: #ef4444; --text: #f1f5f9; --border: #334155; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        /* Layout */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { font-size: 1.5rem; margin: 0; background: linear-gradient(90deg, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
        
        /* Components */
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 16px; }
        .section-title { font-size: 0.85rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 8px; }
        
        /* API Manager */
        .api-manager { background: #0b1120; border: 1px solid #475569; padding: 15px; border-radius: 8px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* Forms */
        label { font-size: 0.8rem; color: #cbd5e1; margin-bottom: 4px; display: block; }
        input, select, textarea { width: 100%; background: #1e293b; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; }
        textarea { height: 100px; resize: vertical; }
        
        /* Buttons */
        .btn { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: filter 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-save { background: #10b981; color: white; flex: 1; }
        .btn-del { background: var(--danger); color: white; }
        .btn:hover { filter: brightness(1.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Gallery */
        .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .img-box { aspect-ratio: 16/9; background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }
        .img-label { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; pointer-events: none; }
        .placeholder { color: #64748b; font-size: 0.9rem; }

        /* Info Card */
        .info-card { background: #0b1120; padding: 12px; border-radius: 6px; border: 1px solid #334155; margin-top: 16px; font-family: monospace; font-size: 0.8rem; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #1e293b; padding-bottom: 8px; }
        .info-label { color: #94a3b8; font-weight: bold; }
        .info-value { color: #60a5fa; word-break: break-all; text-align: right; max-width: 70%; }

        /* Debug */
        details { margin-top: 20px; background: #000; border-radius: 8px; }
        summary { padding: 10px; color: #64748b; font-family: monospace; cursor: pointer; }
        pre { color: #22c55e; padding: 15px; margin: 0; overflow: auto; max-height: 200px; font-size: 0.8rem; }

        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1>Gemini 3 Pro Controller</h1>
    <div style="font-size: 0.8rem; color: #64748b;">v3.2 Multi-Image Fix</div>
</header>

<div class="grid">
    <!-- å·¦å´ï¼šæ§åˆ¶é¢æ¿ -->
    <div class="panel">
        
        <!-- API ç®¡ç†å€ -->
        <div class="api-manager">
            <div class="section-title">ğŸ“¡ ç·šè·¯è¨­å®š (Endpoints)</div>
            <div class="form-group">
                <label>å·²å­˜ç·šè·¯</label>
                <div class="row">
                    <select id="savedApis" onchange="loadApiConfig()">
                        <option value="">-- é¸æ“‡æˆ–æ–°å¢ --</option>
                    </select>
                    <button class="btn btn-del" onclick="deleteApi()" title="åˆªé™¤">ğŸ—‘ï¸</button>
                </div>
            </div>
            <div style="margin-bottom:10px;"><label>åç¨±</label><input type="text" id="apiName" placeholder="My Proxy" /></div>
            <div style="margin-bottom:10px;"><label>URL</label><input type="text" id="apiUrl" placeholder="https://..." /></div>
            <div style="margin-bottom:10px;"><label>Key (é¸å¡«)</label><input type="password" id="apiKey" placeholder="AIzaSy..." /></div>
            <button class="btn btn-save" style="width:100%" onclick="saveApi()">ğŸ’¾ å„²å­˜ / æ›´æ–°</button>
        </div>

        <!-- åƒæ•¸å€ -->
        <div>
            <div class="section-title">ğŸ¨ ç”Ÿæˆåƒæ•¸</div>
            <label>æç¤ºè© (Prompt)</label>
            <textarea id="prompt">Cyberpunk city, neon lights, 8k, realistic</textarea>
        </div>
        
        <div class="row">
            <div style="flex:1">
                <label>æ¯”ä¾‹</label>
                <select id="aspectRatio">
                    <option value="16:9">16:9</option>
                    <option value="1:1">1:1</option>
                    <option value="9:16">9:16</option>
                    <option value="4:3">4:3</option>
                    <option value="3:4">3:4</option>
                </select>
            </div>
            <div style="flex:1">
                <label>æ•¸é‡</label>
                <select id="sampleCount">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="4">4</option>
                </select>
            </div>
        </div>

        <button id="btnGenerate" class="btn btn-primary" onclick="generate()">ğŸš€ é–‹å§‹ç”Ÿæˆ</button>
        <div id="status" style="text-align:center; margin-top:10px; color:#94a3b8; font-size:0.85rem;">Ready</div>
    </div>

    <!-- å³å´ï¼šçµæœå±•ç¤º -->
    <div class="panel">
        <div class="section-title">ğŸ–¼ï¸ çµæœé è¦½</div>
        <div id="gallery" class="gallery">
            <div class="img-box"><span class="placeholder">åœ–ç‰‡å°‡é¡¯ç¤ºæ–¼æ­¤</span></div>
        </div>

        <!-- è³‡è¨Šé¢æ¿ -->
        <div class="info-card">
            <div class="section-title" style="border:none; margin:0 0 8px 0; color:#3b82f6;">ğŸ“Š Transaction Details</div>
            <div class="info-row"><span class="info-label">Target URL:</span><span class="info-value" id="dispTarget">N/A</span></div>
            <div class="info-row"><span class="info-label">Auth Key:</span><span class="info-value" id="dispKey">None</span></div>
            <div class="info-row"><span class="info-label">Images Found:</span><span class="info-value" id="dispCount">0</span></div>
            <div class="info-row" style="border:none;"><span class="info-label">Response Size:</span><span class="info-value" id="dispSize">0 KB</span></div>
        </div>
    </div>
</div>

<details>
    <summary>ğŸ› ï¸ Raw API Output</summary>
    <pre id="apiOutput">// Log...</pre>
</details>

<script>
    // --- 1. API ç®¡ç†é‚è¼¯ ---
    const STORAGE_KEY = 'gemini_api_configs_v3';
    let apiList = [];

    window.onload = () => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            apiList = JSON.parse(stored);
        } else {
            apiList = [{
                name: "Example Appmedo",
                url: "https://api-integrations.appmedo.com/app-7r29gu4xs001/api-Xa6JZ58oPMEa/v1beta/models/gemini-3-pro-image-preview:generateContent",
                key: ""
            }];
            saveToStorage();
        }
        renderApiSelect();
        // é è¨­é¸ä¸­ç¬¬ä¸€å€‹
        if(apiList.length > 0) {
            document.getElementById('savedApis').value = 0;
            loadApiConfig();
        }
    };

    function renderApiSelect() {
        const sel = document.getElementById('savedApis');
        sel.innerHTML = '<option value="">-- æ–°å¢ç·šè·¯ --</option>';
        apiList.forEach((api, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.text = api.name;
            sel.appendChild(opt);
        });
    }

    function loadApiConfig() {
        const idx = document.getElementById('savedApis').value;
        if (idx === "") {
            document.getElementById('apiName').value = "";
            document.getElementById('apiUrl').value = "";
            document.getElementById('apiKey').value = "";
        } else {
            const api = apiList[idx];
            document.getElementById('apiName').value = api.name;
            document.getElementById('apiUrl').value = api.url;
            document.getElementById('apiKey').value = api.key || "";
        }
    }

    function saveApi() {
        const name = document.getElementById('apiName').value;
        const url = document.getElementById('apiUrl').value;
        const key = document.getElementById('apiKey').value;
        const idx = document.getElementById('savedApis').value;

        if (!name || !url) return alert("åç¨±å’Œ URL ç‚ºå¿…å¡«ï¼");

        const newConfig = { name, url, key };
        if (idx === "") apiList.push(newConfig);
        else apiList[idx] = newConfig;

        saveToStorage();
        renderApiSelect();
        document.getElementById('savedApis').value = (idx==="") ? apiList.length-1 : idx;
        alert("å·²å„²å­˜");
    }

    function deleteApi() {
        const idx = document.getElementById('savedApis').value;
        if (idx === "") return;
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
            apiList.splice(idx, 1);
            saveToStorage();
            renderApiSelect();
            loadApiConfig();
        }
    }

    function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(apiList)); }


    // --- 2. ç”Ÿæˆé‚è¼¯ (åŒ…å«å¤šåœ–ä¿®å¾©) ---
    async function generate() {
        const url = document.getElementById('apiUrl').value;
        const key = document.getElementById('apiKey').value;
        const prompt = document.getElementById('prompt').value;
        const aspectRatio = document.getElementById('aspectRatio').value;
        const sampleCount = parseInt(document.getElementById('sampleCount').value);

        // UI å…ƒç´ 
        const btn = document.getElementById('btnGenerate');
        const status = document.getElementById('status');
        const gallery = document.getElementById('gallery');
        const apiOut = document.getElementById('apiOutput');
        
        // Info å…ƒç´ 
        const dTarget = document.getElementById('dispTarget');
        const dKey = document.getElementById('dispKey');
        const dCount = document.getElementById('dispCount');
        const dSize = document.getElementById('dispSize');

        if (!url || !prompt) return alert("è«‹å¡«å¯« URL å’Œ Prompt");

        // é–å®š UI
        btn.disabled = true;
        status.innerText = "Processing...";
        gallery.innerHTML = Array(sampleCount).fill('<div class="img-box"><span class="placeholder">...</span></div>').join('');
        dTarget.innerText = url;
        dKey.innerText = key ? "Provided (Hidden)" : "None";
        dCount.innerText = "-";
        dSize.innerText = "-";

        try {
            const response = await fetch('/api/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-target-url': url,
                    'x-target-key': key
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseModalities: ["IMAGE"],
                        imageConfig: { aspectRatio, imageCount: sampleCount }
                    }
                })
            });

            const rawText = await response.text();
            dSize.innerText = (rawText.length / 1024 / 1024).toFixed(2) + " MB";

            let data;
            try { data = JSON.parse(rawText); } catch(e) { throw new Error("API Returned Non-JSON: " + rawText.substring(0, 300)); }

            apiOut.innerText = JSON.stringify(data, null, 2).substring(0, 5000);
            status.innerText = `HTTP ${response.status}`;

            // --- æ ¸å¿ƒä¿®å¾©ï¼šå…¨æ–¹ä½åœ–ç‰‡è§£æ ---
            const images = [];
            if (data.candidates && Array.isArray(data.candidates)) {
                data.candidates.forEach(cand => {
                    if (cand.content && cand.content.parts) {
                        cand.content.parts.forEach(part => {
                            // æƒ…æ³ A: æ¨™æº–æ ¼å¼
                            if (part.inlineData?.data) {
                                images.push(part.inlineData.data);
                            }
                            // æƒ…æ³ B: Markdown æ ¼å¼ (æ”¯æ´åŒä¸€ part å…§æœ‰å¤šå¼µ)
                            else if (part.text) {
                                const regex = /data:image\/[^;]+;base64,([A-Za-z0-9+/=]+)/g;
                                let match;
                                while ((match = regex.exec(part.text)) !== null) {
                                    if(match[1]) images.push(match[1]);
                                }
                            }
                        });
                    }
                });
            }

            // å»é‡
            const uniqueImages = [...new Set(images)];
            dCount.innerText = uniqueImages.length;

            if (uniqueImages.length > 0) {
                gallery.innerHTML = uniqueImages.map((b64, i) => `
                    <div class="img-box">
                        <img src="data:image/png;base64,${b64}" onclick="window.open(this.src)" />
                        <div class="img-label">#${i+1}</div>
                    </div>
                `).join('');
                status.innerText = `âœ… Success: ${uniqueImages.length} images`;
                status.style.color = "#4ade80";
            } else {
                gallery.innerHTML = `<div class="img-box" style="border-color:#f59e0b"><span class="placeholder" style="color:#f59e0b">ç„¡åœ–ç‰‡æ•¸æ“š</span></div>`;
                status.innerText = "âš ï¸ No Images Found";
                status.style.color = "#f59e0b";
            }

        } catch (e) {
            status.innerText = "âŒ Error";
            status.style.color = "red";
            apiOut.innerText += `\n\nERROR: ${e.message}`;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
